# Utilized_Cost.py - autogenerated file
import os
from dotenv import load_dotenv
import pandas as pd
from sqlalchemy import create_engine
import psycopg2

# Load environment variables from .env
load_dotenv(override=True)

DB_PARAMS = {
    "dbname": os.getenv("DB_NAME"),
    "user": os.getenv("DB_USER"),
    "password": os.getenv("DB_PASSWORD"),
    "host": os.getenv("DB_HOST"),
    "port": os.getenv("DB_PORT")
}

# SQLAlchemy engine for reading
engine_str = f"postgresql://{DB_PARAMS['user']}:{DB_PARAMS['password']}@{DB_PARAMS['host']}:{DB_PARAMS['port']}/{DB_PARAMS['dbname']}"
engine = create_engine(engine_str)

# Step 1: Fetch Total Price with Imbalance and DA LMPs Data
query = """
    SELECT tpw.hierarchy_id, tpw.date, tpw.he, 
           tpw.data AS total_price_wimbalance, da_lmps.data AS da_lmps
    FROM miso_vlr_tot_pricewimbalance tpw
    JOIN miso_vlr_da_lmps da_lmps
    ON tpw.hierarchy_id = da_lmps.hierarchy_id 
    AND tpw.date = da_lmps.date 
    AND tpw.he = da_lmps.he
    WHERE tpw.hierarchy_id BETWEEN 1 AND 19
"""
df = pd.read_sql(query, engine)

# Step 2: Add metadata
df["date"] = pd.to_datetime(df["date"])
df["year"] = df["date"].dt.year
df["month"] = df["date"].dt.month
df["day"] = df["date"].apply(lambda x: x.isoweekday() % 7 + 1)
df["day_type"] = df["date"].dt.dayofweek.apply(lambda x: "WeekEnd" if x in [5, 6] else "WeekDay")
# df["hour_type"] = df["he"].apply(lambda x: "OnPeak" if 7 <= x <= 22 else "OffPeak")
df["hour_type"] = df["he"].apply(lambda x: "OnPeak" if 8 <= x <= 23 else "OffPeak")

# Step 3: Define block type
def calculate_block_type(row):
    if row["day_type"] == "WeekDay" and row["hour_type"] == "OnPeak":
        return "5x16"
    elif row["day_type"] == "WeekEnd" and row["hour_type"] == "OnPeak":
        return "2x16"
    else:
        return "7x8"

df["block_type"] = df.apply(calculate_block_type, axis=1)

# Step 4: Compute Utilized Cost (TPwI - DA_LMPs)
df["data"] = df.apply(lambda row: (row["total_price_wimbalance"] - row["da_lmps"]) 
                      if row["da_lmps"] is not None else 0, axis=1).round(6)

# Step 5: Select final columns
df = df[[
    "hierarchy_id", "date", "year", "month", "day",
    "day_type", "he", "hour_type", "block_type", "data"
]]

# Step 6: Insert into miso_vlr_utilized_cost
try:
    conn = psycopg2.connect(**DB_PARAMS)
    cursor = conn.cursor()

    insert_query = """
        INSERT INTO miso_vlr_utilized_cost 
        (hierarchy_id, date, year, month, day, day_type, he, hour_type, block_type, data)
        VALUES (%(hierarchy_id)s, %(date)s, %(year)s, %(month)s, %(day)s, %(day_type)s, %(he)s, %(hour_type)s, %(block_type)s, %(data)s)
        ON CONFLICT (hierarchy_id, date, he) 
        DO UPDATE SET data = EXCLUDED.data
    """

    cursor.executemany(insert_query, df.to_dict(orient="records"))
    conn.commit()
    cursor.close()
    conn.close()

    print("✅ Data inserted into `miso_vlr_utilized_cost` successfully!")

except Exception as e:
    print(f"❌ Error inserting into `miso_vlr_utilized_cost`: {e}")
